name: Publish

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease
      prerelease_type:
        description: 'Prerelease type (only used if version_type is prerelease)'
        required: false
        default: 'beta'
        type: choice
        options:
          - alpha
          - beta
          - rc
      dry_run:
        description: 'Dry run (skip actual publishing)'
        required: false
        default: false
        type: boolean

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'yarn'

      - name: Setup Yarn
        run: corepack enable

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run tests
        run: yarn test

      - name: Run linting
        run: yarn lint

      - name: Run type checking
        run: yarn typecheck

      - name: Build library
        run: yarn prepare

      - name: Configure Git
        run: |
              git config user.name "Gautham495"
              git config user.email "kinggautham495@gmail.com"

      - name: Create release
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "ğŸ§ª Running in dry-run mode"
            yarn release --dry-run --ci --${{ github.event.inputs.version_type }}
          else
            if [ "${{ github.event.inputs.version_type }}" = "prerelease" ]; then
              echo "ğŸš€ Creating prerelease: ${{ github.event.inputs.prerelease_type }}"
              yarn release --prerelease=${{ github.event.inputs.prerelease_type }} --ci
            else
              echo "ğŸš€ Creating ${{ github.event.inputs.version_type }} release"
              yarn release --${{ github.event.inputs.version_type }} --ci
            fi
          fi

      - name: Upload build artifacts
        if: github.event.inputs.dry_run != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            lib/
            nitrogen/
          retention-days: 30

      - name: Notify success
        if: success() && github.event.inputs.dry_run != 'true'
        run: |
          echo "âœ… Release completed successfully!"
          echo "ğŸ“¦ Package published to npm"
          echo "ğŸ·ï¸  Git tag created"
          echo "ğŸ“ GitHub release created"

      - name: Notify dry run success
        if: success() && github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸ§ª Dry run completed successfully!"
          echo "ğŸ“‹ Check the logs above to see what would be released"